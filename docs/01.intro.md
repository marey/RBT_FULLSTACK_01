<img src="https://unsw-au.oss-cn-hongkong.aliyuncs.com/web/cover.png"/>

# Express 后端接口开发

Express 是目前最流行的基于 Node.js 的 Web 开发框架，可以快速地搭建一个完整功能的网站。

## Express 特性

- 简单易学
- 丰富的基础 API 支持、以及常见的 HTTP 辅助程序，例如重定向、缓存等
- 强大的路由功能
- 灵活的中间件
- 高性能
- 非常稳定（源代码几乎百分百的测试覆盖率）
- 视图系统支持 14 个以上的主流模版引擎

## 目录说明

常见的代码开发目录结构

```shell
├── app.js
├── docs
│   ├── env-init.md
│   ├── express-swagger.md
│   ├── express-validator.md
│   ├── firebase.md
│   ├── middle-wares.md
│   ├── mocha.md
│   ├── mongoose.md
│   ├── prettier.md
│   ├── router.md
│   └── swagger.md
├── node_modules
├── package-lock.json
├── package.json
├── src
│   ├── config
│   ├── controller
│   ├── db
│   ├── middlewares
│   ├── routes
│   ├── service
│   ├── swagger
│   ├── utils
│   └── validators
└── test
    ├── auth.test.js
    └── user.test.js
```

## 常见的`npm libiary`

包类库搜索地址：https://www.npmjs.com/

```
    "bcryptjs": "^2.4.3",
    "body-parser": "^1.20.2",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "express-async-errors": "^3.1.1",
    "express-validator": "^7.0.1",
    "jsonwebtoken": "^9.0.1",
    "mongoose": "^7.3.4",
    "morgan": "^1.10.0",
    "nodemailer": "^6.9.4",
    "nodemailer-smtp-transport": "^2.7.4",
    "nodemon": "^2.0.22",
    "pg": "^8.11.5",
    "pg-hstore": "^2.3.4",
    "sequelize": "^6.37.3"
```

## 开始开发

### 安装类库

```
npm install
```

或者

```
npm install express
```

### 数据库设计

参考地址：https://www.notion.so/irbtree/c4a4a5c96f944ff6a0ce3d08aa9b6f4c?pvs=4

### 配置数据库

- 创建config文件或者使用`.env`文件

  `DB: pgm-j6cm4f4z8w72auhjpo.pg.rds.aliyuncs.com`

  `User: rbt_full_stack`

  `Password: Rbt_full_stack123`

- 创建模型

```javascript
const { DataTypes } = require('sequelize');

// 用户模型
const UserModel = {
  id: {
    type: DataTypes.INTEGER,
    autoIncrement: true,
    primaryKey: true,
  },
  userName: {
    type: DataTypes.STRING,
    // 不允许为空
    allowNull: false,
    // username 必须是唯一的
    unique: true,
  },
  hashedPassword: {
    // 字符串长度
    type: DataTypes.STRING(64),
    // 不允许为空
    allowNull: false,
    // 使用正则表达式验证长度和格式是正确的
    validate: {
      is: /^[0-9a-f]{64}$/i,
    },
  },
  email: {
    type: DataTypes.STRING,
    // 不能为空
    allowNull: false,
    // 邮箱必须是唯一的
    unique: true,
    // 必须是邮箱
    isEmail: true,
  },
  // 用户的角色
  role: {
    type: DataTypes.ENUM('Admin', 'User', 'Tutor'),
    defaultValue: 'User', // 默认角色是User
  },
  // 头像的地址
  avatarUrl: {
    type: DataTypes.STRING,
    // 必须是URL地址
    isUrl: true,
  },
  // 创建时间
  createdAt: {
    // 创建时间
    type: DataTypes.DATE,
    // 默认是当前的时间
    defaultValue: Date.now,
  },
  // 更新时间
  updatedAt: {
    // 更新时间
    type: DataTypes.DATE,
    // 默认是当前的时间
    defaultValue: Date.now,
  },
};

module.exports = UserModel;
```

- 配置数据库连接

```javascript
const { Sequelize } = require('sequelize');

const { DB_URL } = require('../config/config.default');

// Option 1: Passing a connection URI
// const sequelize = new Sequelize('sqlite::memory:') // Example for sqlite
// const sequelize = new Sequelize('postgres://user:pass@example.com:5432/dbname'); // Example for postgres
// console.log('db url: ', DB_URL);
const sequelize = new Sequelize(DB_URL);

// Option 2: Passing parameters separately (sqlite)
// const sequelize = new Sequelize({
//   dialect: 'sqlite',
//   storage: 'path/to/database.sqlite'
// });

// Option 3: Passing parameters separately (other dialects)
// const sequelize = new Sequelize('rbt_db', 'rbt_user', '123456', {
//   host: 'localhost',
//   dialect:
//     'postgres' /* one of 'mysql' | 'postgres' | 'sqlite' | 'mariadb' | 'mssql' | 'db2' | 'snowflake' | 'oracle' */,
// });

(async () => {
  try {
    await sequelize.authenticate();
    console.log('Connection has been established successfully.');
    await sequelize.sync({ force: true });
    console.log('All models were synchronized successfully.');
  } catch (error) {
    console.error('Unable to connect to the database:', error);
  }
})();

// 用户模型
const UserModel = sequelize.define('User', require('./model/user'));
// 用户的验证码
const UserCodeModel = sequelize.define('UserCode', require('./model/user_code'));

// 导出模型
module.exports = {
  UserModel,
  UserCodeModel,
};
```

### 接口设计文档

https://irbtree.notion.site/c37873da1e8b4015a4afabaca63f043e?pvs=4

https://www.notion.so/irbtree/2063b0d067c444e0b94c7598257be26d?pvs=4

### API 接口开发

参考地址：

https://expressjs.com/en/guide/routing.html

```javascript
const express = require('express')
const app = express()

// respond with "hello world" when a GET request is made to the homepage
app.get('/', (req, res) => {
  res.send('hello world')
})
```

### 接口部署

### 接口测试

API Fox： https://apifox.com/

## 中间件的概念

简单说，中间件（middleware）就是处理HTTP请求的函数。它最大的特点就是，一个中间件处理完，再传递给下一个中间件。App实例在运行过程中，会调用一系列的中间件。

每个中间件可以从App实例，接收三个参数，依次为request对象（代表HTTP请求）、response对象（代表HTTP回应），next回调函数（代表下一个中间件）。每个中间件都可以对HTTP请求（request对象）进行加工，并且决定是否调用next方法，将request对象再传给下一个中间件。

一个不进行任何操作、只传递request对象的中间件，就是下面这样。

```javascript
function uselessMiddleware(req, res, next) {
  	next();
}
```

上面代码的next就是下一个中间件。如果它带有参数，则代表抛出一个错误，参数为错误文本。

抛出错误以后，后面的中间件将不再执行，直到发现一个错误处理函数为止。

use是express注册中间件的方法，它返回一个函数。下面是一个连续调用两个中间件的例子。

```javascript
var express = require("express");
var http = require("http");

var app = express();

app.use(function(request, response, next) {
  console.log("In comes a " + request.method + " to " + request.url);
  next();
});

app.use(function(request, response) {
  response.writeHead(200, { "Content-Type": "text/plain" });
  response.end("Hello world!\n");
});

http.createServer(app).listen(1337);
```

上面代码使用`app.use`方法，注册了两个中间件。收到HTTP请求后，先调用第一个中间件，在控制台输出一行信息，然后通过`next`方法，将执行权传给第二个中间件，输出HTTP回应。由于第二个中间件没有调用`next`方法，所以request对象就不再向后传递了。

## 基于路由的 Express 开发

### 增加接口路由

- 注册用户
- 登录用户
- 获取用户列表

### 增加参数效验

### 增加token登录

- token的生成
- 利用Header

### 服务器部署

- 远程测试服务器部署

### 服务器测试

- 手动测试
- 编写测试脚本
